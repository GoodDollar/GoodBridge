import { ethers } from 'hardhat';
import { expect } from 'chai';

describe('TestRLPParser', function () {
  it('should return the correct block receiptsRoot for Celo', async function () {
    const rlpHeader =
      '0xf9025ba0da3ad238e953b53fbff4abf9aca0695fe1d184f7323a13f6dfaf301f86fa024e94a66e834933e2c51542e95477d71f5a0aaf7d4999a05ef9062b21491902565ecc4da5d11840ed39fee113098808bf12fdf48c9ac0f3a03810c781bd05b16d56cacbb3933c92cc337b1a0d69c80047225d4f0cd28ca690a0bb378148b985cbd491bea26a17b17d1cd55dcb4a6625a2f4c2f76b35eea27f0eb901000080000000020000000024004002000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000200020000000000000000084000200400000000000000000000000000000000040000000040000000800800000000000000004081000000000000000000008000000040008000000000080000000000000080000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000010000000200000000000000000000000000040000000000000000000000002000002000000000000000000002000000000000000000084011e1cec830a987a846438756fb8afd983010700846765746889676f312e31372e3133856c696e7578000000000000f88dc0c080b841e87a93c9a5871e405b8d4d63821c0ad490b49a656babce6c07eb4857f58662370c68e0385af96cfb397c75c1513bf7065a8cd89e686e3e804b0fc48d7a2dfa8500c3808080f8418e3fffffffffffffffffffefffffffb0797a8a3efe1aa3717445ab60433dc90070aec61b12306febe4595ceb86cdcb87a2d39e3c112d243906e63bbec87e550180';
    const chainId = 42220;
    const expectedRoot = '0xbb378148b985cbd491bea26a17b17d1cd55dcb4a6625a2f4c2f76b35eea27f0e';

    const RLPParser = await ethers.getContractFactory('TestRLPParser');
    const parser = await RLPParser.deploy();

    const root = await parser.testGetBlockReceiptsRoot(chainId, rlpHeader);
    expect(root).to.equal(expectedRoot);
  });

  it('should return the correct block number for Celo', async function () {
    const rlpHeader =
      '0xf9025ba0da3ad238e953b53fbff4abf9aca0695fe1d184f7323a13f6dfaf301f86fa024e94a66e834933e2c51542e95477d71f5a0aaf7d4999a05ef9062b21491902565ecc4da5d11840ed39fee113098808bf12fdf48c9ac0f3a03810c781bd05b16d56cacbb3933c92cc337b1a0d69c80047225d4f0cd28ca690a0bb378148b985cbd491bea26a17b17d1cd55dcb4a6625a2f4c2f76b35eea27f0eb901000080000000020000000024004002000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000200020000000000000000084000200400000000000000000000000000000000040000000040000000800800000000000000004081000000000000000000008000000040008000000000080000000000000080000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000010000000200000000000000000000000000040000000000000000000000002000002000000000000000000002000000000000000000084011e1cec830a987a846438756fb8afd983010700846765746889676f312e31372e3133856c696e7578000000000000f88dc0c080b841e87a93c9a5871e405b8d4d63821c0ad490b49a656babce6c07eb4857f58662370c68e0385af96cfb397c75c1513bf7065a8cd89e686e3e804b0fc48d7a2dfa8500c3808080f8418e3fffffffffffffffffffefffffffb0797a8a3efe1aa3717445ab60433dc90070aec61b12306febe4595ceb86cdcb87a2d39e3c112d243906e63bbec87e550180';
    const chainId = 42220;
    const expectedBlockNumber = Number(0x11e1cec);

    const RLPParser = await ethers.getContractFactory('TestRLPParser');
    const parser = await RLPParser.deploy();

    const blockNumber = await parser.testGetBlockNumber(chainId, rlpHeader);
    expect(blockNumber).to.equal(expectedBlockNumber);
  });

  it('should return the correct block header fields for Celo', async function () {
    const rlpHeader =
      '0xf9025ba0da3ad238e953b53fbff4abf9aca0695fe1d184f7323a13f6dfaf301f86fa024e94a66e834933e2c51542e95477d71f5a0aaf7d4999a05ef9062b21491902565ecc4da5d11840ed39fee113098808bf12fdf48c9ac0f3a03810c781bd05b16d56cacbb3933c92cc337b1a0d69c80047225d4f0cd28ca690a0bb378148b985cbd491bea26a17b17d1cd55dcb4a6625a2f4c2f76b35eea27f0eb901000080000000020000000024004002000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000200020000000000000000084000200400000000000000000000000000000000040000000040000000800800000000000000004081000000000000000000008000000040008000000000080000000000000080000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000010000000200000000000000000000000000040000000000000000000000002000002000000000000000000002000000000000000000084011e1cec830a987a846438756fb8afd983010700846765746889676f312e31372e3133856c696e7578000000000000f88dc0c080b841e87a93c9a5871e405b8d4d63821c0ad490b49a656babce6c07eb4857f58662370c68e0385af96cfb397c75c1513bf7065a8cd89e686e3e804b0fc48d7a2dfa8500c3808080f8418e3fffffffffffffffffffefffffffb0797a8a3efe1aa3717445ab60433dc90070aec61b12306febe4595ceb86cdcb87a2d39e3c112d243906e63bbec87e550180';
    const expectedBlockFields = 10;

    const RLPParser = await ethers.getContractFactory('TestRLPParser');
    const parser = await RLPParser.deploy();

    const blockFields = await parser.testGetBlockHeaderNumFields(rlpHeader);
    expect(blockFields).to.equal(expectedBlockFields);
  });

  it('should return the correct block header fields for Celo 1.8 hardfork', async function () {
    const rlpHeader =
      '0xf902b2a0b1fd6ed9f44c8d7db499c9756a2b6a5eb3441144bbda7462a4d94c6f203a9d67a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347944b64995254836fa1d104a85df94e0401689e587aa0639ecb2b9601334f7037ebea9b6137780a1b29aabd53b003394e545a1eb29ddda07d882b510134c49281e5450abde5acc469e4c7ae749e1d6a00cc0586fcefa6eca081201822c9456e55c6f7c1e5920ce56b009728e789f624889161b021a85447d1b90100008040000040000000002400008000000000000000004000020004040020010000008000000000000001800000010408000000008000000000000000012000000008000810000000200140080008000000c000200c0008000000001200000002000000000000002000004044400088000000040000100000400100100008200000000000000080004000100000000008000040800000008800000000040000000200008000000000000008000002000020000810000000000000800000000400208004020000001000000000000020000000000000100280100010000000002000100220000000000000000200800000000000008000200000000000040000008084014a03038401e848008325773b846513f56fb8afd983010800846765746889676f312e31372e3133856c696e7578000000000000f88dc0c080b841a7cb060bda6354982dbc3e6149ef999f6c98834fc481aef5713f0fe133ac23c42fca718d1dcb50ece2b0e33e342261f74098f99864b6983d3cafbbb0a197235500c3808080f8418e3fffdff7ffffeffffdffffffffffb0d3bccb1c82b1553602a801ed9b2c9c6f4d44c043b4c09f183d78018901db7a175487b2e65564475985de61c4b013278080a0000000000000000000000000000000000000000000000000000000000000000088000000000000000085012a05f200';
    const expectedBlockFields = 16;

    const RLPParser = await ethers.getContractFactory('TestRLPParser');
    const parser = await RLPParser.deploy();

    const blockFields = await parser.testGetBlockHeaderNumFields(rlpHeader);
    expect(blockFields).to.equal(expectedBlockFields);
  });

  it('should return the correct block number for Celo after hardfork', async function () {
    const rlpHeader =
      '0xf902b2a0b1fd6ed9f44c8d7db499c9756a2b6a5eb3441144bbda7462a4d94c6f203a9d67a01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347944b64995254836fa1d104a85df94e0401689e587aa0639ecb2b9601334f7037ebea9b6137780a1b29aabd53b003394e545a1eb29ddda07d882b510134c49281e5450abde5acc469e4c7ae749e1d6a00cc0586fcefa6eca081201822c9456e55c6f7c1e5920ce56b009728e789f624889161b021a85447d1b90100008040000040000000002400008000000000000000004000020004040020010000008000000000000001800000010408000000008000000000000000012000000008000810000000200140080008000000c000200c0008000000001200000002000000000000002000004044400088000000040000100000400100100008200000000000000080004000100000000008000040800000008800000000040000000200008000000000000008000002000020000810000000000000800000000400208004020000001000000000000020000000000000100280100010000000002000100220000000000000000200800000000000008000200000000000040000008084014a03038401e848008325773b846513f56fb8afd983010800846765746889676f312e31372e3133856c696e7578000000000000f88dc0c080b841a7cb060bda6354982dbc3e6149ef999f6c98834fc481aef5713f0fe133ac23c42fca718d1dcb50ece2b0e33e342261f74098f99864b6983d3cafbbb0a197235500c3808080f8418e3fffdff7ffffeffffdffffffffffb0d3bccb1c82b1553602a801ed9b2c9c6f4d44c043b4c09f183d78018901db7a175487b2e65564475985de61c4b013278080a0000000000000000000000000000000000000000000000000000000000000000088000000000000000085012a05f200';
    const chainId = 42220;
    const expectedBlockNumber = Number(21627651);

    const RLPParser = await ethers.getContractFactory('TestRLPParser');
    const parser = await RLPParser.deploy();

    const blockNumber = await parser.testGetBlockNumber(chainId, rlpHeader);
    expect(blockNumber).to.equal(expectedBlockNumber);
  });

  it('should return the correct block parent and number for Celo', async function () {
    const rlpHeader =
      '0xf9025ba0da3ad238e953b53fbff4abf9aca0695fe1d184f7323a13f6dfaf301f86fa024e94a66e834933e2c51542e95477d71f5a0aaf7d4999a05ef9062b21491902565ecc4da5d11840ed39fee113098808bf12fdf48c9ac0f3a03810c781bd05b16d56cacbb3933c92cc337b1a0d69c80047225d4f0cd28ca690a0bb378148b985cbd491bea26a17b17d1cd55dcb4a6625a2f4c2f76b35eea27f0eb901000080000000020000000024004002000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000200020000000000000000084000200400000000000000000000000000000000040000000040000000800800000000000000004081000000000000000000008000000040008000000000080000000000000080000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000010000000200000000000000000000000000040000000000000000000000002000002000000000000000000002000000000000000000084011e1cec830a987a846438756fb8afd983010700846765746889676f312e31372e3133856c696e7578000000000000f88dc0c080b841e87a93c9a5871e405b8d4d63821c0ad490b49a656babce6c07eb4857f58662370c68e0385af96cfb397c75c1513bf7065a8cd89e686e3e804b0fc48d7a2dfa8500c3808080f8418e3fffffffffffffffffffefffffffb0797a8a3efe1aa3717445ab60433dc90070aec61b12306febe4595ceb86cdcb87a2d39e3c112d243906e63bbec87e550180';
    const chainId = 42220;
    const expectedBlockNumber = Number(0x11e1cec);
    const expectedParentHash = '0xda3ad238e953b53fbff4abf9aca0695fe1d184f7323a13f6dfaf301f86fa024e';

    const RLPParser = await ethers.getContractFactory('TestRLPParser');
    const parser = await RLPParser.deploy();

    const [blockNumber, parentHash] = await parser.testGetBlockParentAndNumber(chainId, rlpHeader);
    expect(blockNumber).to.equal(expectedBlockNumber);
    expect(parentHash).to.equal(expectedParentHash);
  });
});
